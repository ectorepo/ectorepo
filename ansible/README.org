#+TITLE:     Ectorepo: Ansible
#+AUTHOR:    David Conner
#+EMAIL:     aionfork@gmail.com
#+DESCRIPTION: notes

The docs are now greppable. I wish I had realized this sooner.

* Snippets

** Automated Snippet Generation

The repo [[github:memoryleak/AdvancedAnsibleSnippets][memoryleak/AdvancedAnsibleSnippets]] has 7000 ansible snippets and
[[emacsfodder/sublime2yas][emacsfodder/sublime2yas]] wasn't written in python, so it still ... seems to run.

I've only tested a few though. After glancing at the snippet formats for
Sublime, yasnippet, atom and VS Code, they all seem to be based on the same
string substitution format, but have different metadata. There's really no
reason we can't have nice things ... like standardized snippet libraries. One
day, perhaps treesitter would be better for snippets (or at least snippet
extraction)

There's really not much of a point to importing them all at once.

*** Advanced Ansible Snippets Generator

The repo [[github:memoryleak/AdvancedAnsibleSnippetsGenerator][memoryleak/AdvancedAnsibleSnippetsGenerator]] appears to have faculties
for generating snippets from other collections, using some of Ansible's module &
plugin reflection. Installing the deps with =poetry install= and running =make=
then =make build= does generate everything.

The generator constructs Ansible's module path using =module_loader= and
includes collections installed via =ansible-galaxy install -r requirements.txt=.
For each path in =module_path=, it accumulates the plugins with metadata of type
=DocCLI(['ansible snippet generator'])=. Then it attempts to convert them.

It's essentially the same metadata used used for =ansible-doc -s
pfsensible.core.pfsense_aggregate=.

#+begin_src yaml
- name: Manage multiple pfSense firewall aliases, rules, and rule separators, plus interfaces and VLANs
  pfsense_aggregate:
      aggregated_aliases:    # Dict of aliases to apply on the target
      aggregated_interfaces:   # Dict of interfaces to apply on the target
      aggregated_nat_outbounds:   # Dict of nat_outbound rules to apply on the target
      aggregated_nat_port_forwards:   # Dict of nat_port_forward rules to apply
                             # on the target
      aggregated_rule_separators:   # Dict of rule separators to apply on the target
      aggregated_rules:      # Dict of rules to apply on the target
      aggregated_vlans:      # Dict of VLANs to apply on the target
      interface_filter:      # only apply rules and rules separators on those
                             # interfaces (separated by space)
      order_rules:           # rules will be generated following the playbook
                             # order
      purge_aliases:         # delete all the aliases that are not defined into
                             # aggregated_aliases
      purge_interfaces:      # delete all the interfaces that are not defined
                             # into aggregated_int erfaces
      purge_nat_outbounds:   # delete all the nat_outbound rules that are not
                             # defined into aggregated_nat_outbounds
      purge_nat_port_forwards:   # delete all the nat_port_forward rules that
                             # are not defined into aggregated_nat_port_forwards
      purge_rule_separators:   # delete all the rule separators that are not
                               # defined into aggregated_rule_separators
      purge_rules:           # delete all the rules that are not defined into
      purge_vlans:           # delete all the VLANs that are not defined into
                             # aggregated_vlans
#+end_src

I kept wondering where Ansible's =rails generate= functions were. Jesus fucking
christ how do people write this shit?

*** sublime2yas

The =-g= parameter lets you specify a glob like =grafana*.sublime-snippet=.

With the right Bash capture group, you can use the =-G= option to associate
snippets to yas groups, so they don't overload the emacs menu autogeneration.

#+begin_src shell
gem install sublime2yas
mkdir out
sublime2yas --major-mode yaml-mode -o out -d AdvancedAnsibleSnippets
#+end_src

Then, to test in emacs, open some generated files and run =yas-tryout-snippet=

**** By Group

Collections in build

#+begin_src shell
ans_snips=$_ECTO/ansible/snippets/AdvancedAnsibleSnippetsGenerator
ans_build=$ans_snips/build/sublime
snip_collections=()
snip_collections+=$(ls $ans_build | sed -E 's/([0-9a-zA-Z_]+)\.([0-9a-zA-Z_]+)\..*\.sublime-snippet/\1.\2/' | sort | uniq)
echo $snip_collections
#+end_src

#+RESULTS:
: amazon.aws ansible.builtin ansible.netcommon ansible.posix ansible.utils ansible.windows arista.eos awx.awx azure.azcollection become.sublime-snippet block.sublime-snippet check_point.mgmt chocolatey.chocolatey cisco.aci cisco.asa cisco.dnac cisco.intersight cisco.ios cisco.iosxr cisco.ise cisco.meraki cisco.mso cisco.nso cisco.nxos cisco.ucs cloud.common cloudscale_ch.cloud community.aws community.ciscosmb community.crypto community.digitalocean community.dns community.docker community.fortios community.general community.google community.grafana community.hashi_vault community.hrobot community.libvirt community.mongodb community.mysql community.network community.okd community.postgresql community.proxysql community.rabbitmq community.routeros community.sap community.sap_libs community.skydive community.sops community.vmware community.windows community.zabbix containers.podman cyberark.pas dellemc.enterprise_sonic dellemc.openmanage dellemc.os10 dellemc.os6 dellemc.os9 dellemc.powerflex dellemc.unity f5networks.f5_modules fortinet.fortimanager fortinet.fortios frr.frr gluster.gluster google.cloud grafana.grafana hetzner.hcloud hpe.nimble ibm.qradar ibm.spectrum_virtualize infinidat.infinibox infoblox.nios_modules inspur.ispim inspur.sm inventory.sublime-snippet junipernetworks.junos kubernetes.core loop_control.sublime-snippet loop.sublime-snippet lowlydba.sqlserver mellanox.onyx microsoft.ad netapp.aws netapp.azure netapp.cloudmanager netapp.elementsw netapp_eseries.santricity netapp.ontap netapp.storagegrid netapp.um_info netbox.netbox ngine_io.cloudstack ngine_io.exoscale ngine_io.vultr openstack.cloud openvswitch.openvswitch ovirt.ovirt pfsensible.core playbook.sublime-snippet purestorage.flasharray purestorage.flashblade purestorage.fusion sensu.sensu_go splunk.es theforeman.foreman t_systems_mms.icinga_director vmware.vmware_rest vultr.cloud vyos.vyos wti.remote

Transform with collection name as =-G $collection_name=

#+begin_src shell
ans_snips=$_ECTO/ansible/snippets/AdvancedAnsibleSnippetsGenerator
ans_build=$ans_snips/build/sublime
ans_coll=containers.podman
my_snips=yaml-mode
sublime2yas --major-mode yaml-mode -o $my_snips -d $ans_build -g "$ans_coll*.sublime-snippet" -G $ans_coll
#+end_src

Now the yasnippet menu is built so you can click around and explore.

[[file:img/imported-snippets.jpeg]]
